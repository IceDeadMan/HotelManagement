@using Microsoft.AspNetCore.Mvc.Localization
@using System.Globalization;
@inject IViewLocalizer Localizer
@model StartBookingViewModel
@using HotelManagement.Models
@using HotelManagement.ViewModels;

<!-- Start Booking View -->
<!-- This view allows the user to select a room type and stay durati on for booking. -->
<!-- It displays available rooms based on the selected criteria. -->
<!-- It allows adding/removing rooms to/from the booking cart. -->

@{
	ViewData["Title"] = Localizer["CreateBooking"];
}

<!-- Form for selecting room type and stay duration -->
<!-- This form submits the selected criteria to the AvailableRooms action -->
<form method="get" asp-controller="Bookings" asp-action="AvailableRooms">
	<div class="row mb-4">
		<div class="col-md-6">
			<label class="form-label">@Localizer["RoomType"]</label>
			<div class="d-flex flex-column gap-2">
				<div class="form-check border rounded p-3 @(Model.SelectedRoomTypeId == Guid.Empty ? "bg-light border-primary" : "")">
					<input class="form-check-input" type="radio" name="roomTypeId" id="roomTypeAny" value="" @(Model.SelectedRoomTypeId == Guid.Empty ? "checked" : "") />
					<label class="form-check-label w-100" for="roomTypeAny">
						-- @Localizer["LabelAny"] --
					</label>
				</div>

				@foreach (var type in Model.RoomTypes)
				{
					var label = $"{type.Name} - {type.Description} Capacity: {type.Capacity}, Price: {type.Price.ToString("N2", CultureInfo.InvariantCulture) + " €"} per night";
					var isSelected = (type.Id == Model.SelectedRoomTypeId);
					<div class="form-check border rounded p-3 @(isSelected ? "bg-light border-primary" : "")">
						<input class="form-check-input" type="radio" name="roomTypeId" id="roomType_@type.Id" value="@type.Id" @(isSelected ? "checked" : "") />
						<label class="form-check-label w-100" for="roomType_@type.Id">
							@label
						</label>
					</div>
				}
			</div>
		</div>

		<div class="col-md-6">
			<label for="stayDuration" class="form-label">@Localizer["StayDuration"]</label>
			<input type="text" id="stayDuration" name="stayDuration" class="form-control" placeholder=@Localizer["StayDuration"] readonly />
			<div id="stayDurationError" class="text-danger mt-1" style="display:none;">@Localizer["ValidDuration"]</div>
			<div id="staySummary" class="mt-2 text-muted"></div>
			<input type="hidden" name="start" value="@Model.StartDate" />
			<input type="hidden" name="end" value="@Model.EndDate" />
		</div>
	</div>
	<button type="submit" class="btn btn-primary mb-4">@Localizer["ShowRooms"]</button>
</form>

<!-- Display available rooms based on the selected criteria -->
@if (Model.AvailableRooms.Any())
{
	<h4 class="mt-4">@Localizer["AvailableRooms"]</h4>

	<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
		@foreach (var room in Model.AvailableRooms)
		{
			bool isInCart = Model.Cart.RoomIds != null && Model.Cart.RoomIds.Contains(room.Id);
			<div class="col">
				<div class="card h-100 shadow-sm p-3">
					<div class="card-body d-flex flex-column align-items-center text-center">

						<h4 class="card-title mb-2">@Localizer["Room"] @room.RoomNumber</h4>
						<p class="text-muted mb-2">@room.RoomType.Description</p>
						<p class="text-muted mb-3">@room.Description</p>

						<p>@Localizer["RoomType"]: <strong>@room.RoomType?.Name</strong></p>
						<p>@Localizer["RoomCapacity"]: <strong>@room.RoomType?.Capacity</strong></p>
						<p>@Localizer["RoomPrice"]: <strong>@room.RoomType?.Price.ToString("N2", CultureInfo.InvariantCulture) €</strong></p>

						<!-- Room Image Centered -->
						<div class="my-3 d-flex justify-content-center">
							@if (room.RoomType.Photo != null)
							{
								var base64 = Convert.ToBase64String(room.RoomType.Photo);
								var imageSrc = $"data:image/jpeg;base64,{base64}";
								<img src="@imageSrc" class="img-fluid rounded shadow-sm" alt="Room Photo" style="max-height: 300px;" />
							}
							else
							{
								<p class="text-muted">No photo available.</p>
							}
						</div>

						<!-- Buttons side by side -->
						<div class="d-flex gap-2 mt-3 w-100 justify-content-center">
							<form class="booking-cart-form w-50" asp-controller="Bookings" asp-action="@(isInCart ? "RemoveFromBookingCart" : "AddToBookingCart")" method="post">
								<input type="hidden" name="roomId" value="@room.Id" />
								<input type="hidden" name="startDate" value="@Model.StartDate" />
								<input type="hidden" name="endDate" value="@Model.EndDate" />
								@Html.AntiForgeryToken()

								<button type="submit" class="btn @(isInCart ? "btn-danger" : "btn-success") w-100">
									@(isInCart ? @Localizer["RemoveRoom"] : @Localizer["BookRoom"])
								</button>
							</form>

							<a asp-controller="Rooms" asp-action="RoomDetails" asp-route-id="@room.Id" class="btn btn-outline-primary w-50">
								@Localizer["Details"]
							</a>
						</div>

					</div>
				</div>

			</div>
		}
	</div>
}


@section Scripts {
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script src="~/js/utils.js"></script>
	<script>
		const staySummary = document.getElementById("staySummary");
		const startInput = document.querySelector("input[name='start']");
		const endInput = document.querySelector("input[name='end']");
		const errorDiv = document.getElementById("stayDurationError");

		function updateStaySummary(startStr, endStr) {
			if (!startStr || !endStr) {
				staySummary.style.display = "none";
				return;
			}

			const start = new Date(startStr);
			const end = new Date(endStr);

			if (start >= end) {
				staySummary.style.display = "none";
				return;
			}

			const nights = getNights(start, end);
			staySummary.innerHTML = `
				Check-in: <strong>${formatDateDisplay(start)}</strong><br>
				Check-out: <strong>${formatDateDisplay(end)}</strong><br>
				@Localizer["Nights"]: <strong>${nights}</strong>
			`;
			staySummary.style.display = "block";
		}

		flatpickr("#stayDuration", {
			mode: "range",
			dateFormat: "Y-m-d",
			altInput: true,
			altFormat: "d.m.Y",
			//minDate: "today", // allow past dates for testing
			defaultDate: [
				"@Model.StartDate",
				"@Model.EndDate"
			],
			onClose: function (selectedDates) {
				if (selectedDates.length === 2 && selectedDates[0] < selectedDates[1]) {
					startInput.value = formatDateLocal(selectedDates[0]);
					endInput.value = formatDateLocal(selectedDates[1]);
					updateStaySummary(startInput.value, endInput.value);
					errorDiv.style.display = "none";
				} else {
					startInput.value = "";
					endInput.value = "";
					staySummary.style.display = "none";
				}
			}
		});

		document.querySelector("form").addEventListener("submit", function (e) {
			const start = startInput.value;
			const end = endInput.value;

			if (!start || !end) {
				e.preventDefault();
				errorDiv.style.display = "block";
				staySummary.style.display = "none";
			} else {
				errorDiv.style.display = "none";
			}
		});

		// Run summary update on initial page load
		window.addEventListener("DOMContentLoaded", function () {
			updateStaySummary(startInput.value, endInput.value);
		});

		// Add/remove room to booking
		document.querySelectorAll(".booking-cart-form").forEach(form => {
			form.addEventListener("submit", async function (e) {
				e.preventDefault();

				const formData = new FormData(form);
				const actionUrl = form.getAttribute("action");

				const data = {};
				formData.forEach((value, key) => {
					data[key] = value;
				});

				const response = await fetch(actionUrl, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						"RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]')?.value
					},
					body: JSON.stringify(data)
				});

				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						//alert("Action successful!"); //todo maybe popup
						// maybe update the button text/state here instead of reloading
						location.reload();
					} else {
						alert("Action failed.");
					}
				} else {
					const error = await response.text();
					alert("Request failed: " + error);
				}
			});
		});
	</script>
}



