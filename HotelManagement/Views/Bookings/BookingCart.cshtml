@{
	ViewData["Title"] = "Booking Cart";
    var startDate = (DateTime)ViewBag.StartDate;
    var endDate = (DateTime)ViewBag.EndDate;
    var nights = (int)ViewBag.Nights;
    var roomDetails = ViewBag.RoomDetails as List<(HotelManagement.Models.Room, HotelManagement.Models.RoomType)>;
    var totalPrice = (decimal)ViewBag.TotalPrice;
}

@if (roomDetails == null || roomDetails.Count == 0)
{
    <h2>Your booking cart is empty.</h2>
    // Go to create booking page
    <a class="btn btn-primary" asp-controller="Bookings" asp-action="StartBooking">Create Booking</a>
    return;
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<h2>Booking Summary</h2>
<p>Check-in: <strong>@startDate.ToShortDateString()</strong></p>
<p>Check-out: <strong>@endDate.ToShortDateString()</strong></p>
<p>Total Nights: <strong>@nights</strong></p>

<table class="table">
    <thead>
        <tr>
            <th>Room</th>
            <th>Type</th>
            <th>Capacity</th>
            <th>Price per Night</th>
            <th>Subtotal</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var (room, type) in roomDetails)
        {
            <tr>
                <td>@room.RoomNumber</td>
                <td>@type.Description</td>
                <td>@type.Capacity</td>
                <td>@type.Price.ToString("C")</td>
                <td>@((type.Price * nights).ToString("C"))</td>
                <td>
                    <form  class="remove-room-form" asp-controller="Bookings" asp-action="RemoveFromBookingCart" method="post">
                        <input type="hidden" name="roomId" value="@room.Id" />
                        <button type="submit" class="btn btn-danger">Remove</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

<h4>Total: @totalPrice.ToString("C")</h4>

<form asp-controller="Bookings" asp-action="FinalizeBooking" method="post">
    <button type="submit" class="btn btn-success">Finalize Booking</button>
</form>

@section Scripts {
    <script>
        // Remove room from booking cart
        document.querySelectorAll(".remove-room-form").forEach(form => {
			form.addEventListener("submit", async function (e) {
				e.preventDefault();

				const formData = new FormData(form);
				const actionUrl = form.getAttribute("action");

				const data = {};
				formData.forEach((value, key) => {
					data[key] = value;
				});

				const response = await fetch(actionUrl, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						"RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]')?.value
					},
					body: JSON.stringify(data)
				});

				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						//alert("Action successful!"); //todo maybe popup
						// maybe update the button text/state here instead of reloading
						location.reload();
					} else {
						alert("Action failed.");
					}
				} else {
					const error = await response.text();
					alert("Request failed: " + error);
				}
			});
		});
    </script>
}

