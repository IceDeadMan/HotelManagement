@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model HotelManagement.ViewModels.RoomDetailViewModel

<!-- Room Details View -->
<!-- This view displays the details of a room, including its bookings in a calendar and guest reviews. -->
@{
	ViewData["Title"] = Localizer["RoomDetails"];
}

<div class="container mt-4">
	<div class="card shadow-sm">
		<div class="card-body">
			<div class="row">
				<!-- Room details column -->
				<div class="col-md-6">
					<h3 class="card-title">Room @Model.RoomNumber</h3>
					<p class="card-text"><strong>@Localizer["RoomTypeDetail"]:</strong> @Model.RoomTypeName</p>
					<p class="card-text"><strong>@Localizer["RoomCapacityDetail"]:</strong> @Model.RoomTypeCapacity</p>
					<p class="card-text"><strong>@Localizer["RoomDescriptionDetail"]:</strong> @Model.Description</p>
					<p class="card-text"><strong>@Localizer["RoomTypeDescription"]: </strong>@Model.RoomTypeDescription</p>
					<p class="card-text"><strong>@Localizer["PriceDetail"]:</strong> @Model.RoomTypePrice.ToString("C")</p>
					<a asp-action="RoomsList" class="btn btn-secondary mt-4">@Localizer["BackToList"]</a>
				</div>

				<!-- Room photo column -->
				<div class="col-md-6 d-flex align-items-center justify-content-center">
					@if (Model.RoomTypePhoto != null)
					{
						var base64 = Convert.ToBase64String(Model.RoomTypePhoto);
						var imageSrc = $"data:image/jpeg;base64,{base64}";
						<img src="@imageSrc" class="img-fluid rounded shadow-sm" alt="Room Photo" style="max-height: 300px;" />
					}
					else
					{
						<p>No photo available.</p>
					}
				</div>
			</div>

			<!-- Bookings Section only for reception/manager -->
			@if(User.IsInRole("Manager") || User.IsInRole("Receptionist"))
			{
				@if (Model.Bookings?.Any() == true)
				{
					<h5 class="mt-4">@Localizer["BookingsForRoom"]:</h5>
					<ul class="list-group">
						@foreach (var booking in Model.Bookings)
						{
							<li class="list-group-item">
								<strong>@Localizer["BookingGuest"]:</strong> @booking.GuestName
								| <strong>@Localizer["BookingFrom"]:</strong> @booking.StartDate.ToShortDateString()
								| <strong>@Localizer["BookingTo"]:</strong> @booking.EndDate.ToShortDateString()
							</li>
						}
					</ul>
				}
				else
				{
					<p class="text-muted mt-4">@Localizer["RoomNoBooking"]</p>
				}

				<!-- Calendar -->
				<h5 class="mt-4">@Localizer["RoomCalendar"]</h5>
				<div id="calendar" class="border rounded p-2 shadow-sm" style="max-width: 700px; margin: auto;"></div>
			}


			<!-- Generate calendar events from bookings -->
			<script>
				const bookings = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
					Model.Bookings.Select(b => new {
						title = "Booked",
						start = b.StartDate.ToString("yyyy-MM-dd"),
						end = b.EndDate.AddDays(1).ToString("yyyy-MM-dd")
					})
				));
			</script>

			<!-- Initialize FullCalendar -->
			<script>
				document.addEventListener('DOMContentLoaded', function () {
					var calendarEl = document.getElementById('calendar');

					var calendar = new FullCalendar.Calendar(calendarEl, {
						initialView: 'dayGridMonth',
						height: 'auto',
						events: bookings,
						eventColor: '#dc3545',
						selectable: true
					});

					calendar.render();
				});
			</script>

			<!-- Reviews Section -->
			@if (Model.Reviews?.Any() == true)
			{
				<h5 class="mt-5">@Localizer["RoomReviews"]</h5>
				<ul class="list-group">
					@foreach (var review in Model.Reviews.OrderByDescending(r => r.ReviewDate))
					{
						<li class="list-group-item">
							<div class="d-flex justify-content-between">
								<div>
									<div class="text-warning">
										@{
											double starValue = review.Rating / 2.0;
											for (int i = 1; i <= 5; i++)
											{
												if (starValue >= i)
												{
													<i class="fas fa-star"></i> <!-- Full star -->
												}
												else if (starValue >= i - 0.5)
												{
													<i class="fas fa-star-half-alt"></i> <!-- Half star -->
												}
												else
												{
													<i class="far fa-star"></i> <!-- Empty star -->
												}
											}
										}
										<small class="text-muted">@(review.Rating / 2.0)</small>
									</div>
									<br />
									@review.Comment
								</div>
								<small class="text-muted">@review.ReviewDate.ToShortDateString(), By: @review.ReviewerUsername</small>
							</div>
						</li>
					}
				</ul>
			}
			else
			{
				<p class="text-muted mt-4">@Localizer["RoomNoReviews"]</p>
			}
		</div>
	</div>
</div>
